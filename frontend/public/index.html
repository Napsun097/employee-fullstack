<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Manager (Full Stack)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script src="/__/firebase/init.js"></script>

</head>
<body class="bg-light">

    <div class="container mt-5">
        <h2 class="text-center mb-4">Employee Management System</h2>

        <div id="login-section" class="text-center">
            <button onclick="login()" class="btn btn-primary btn-lg">Sign in with Google</button>
        </div>

        <div id="app-section" style="display: none;">
            <div class="card p-4 mb-4">
                <h4>Manage Employee</h4>
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" id="name" class="form-control" placeholder="Name">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="pos" class="form-control" placeholder="Position">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="dept" class="form-control" placeholder="Department">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="salary" class="form-control" placeholder="Salary">
                    </div>
                    <div class="col-md-1">
                        <button onclick="saveEmp()" id="save-btn" class="btn btn-success w-100">Save</button>
                    </div>
                    <div class="col-md-12 text-end">
                         <button onclick="resetForm()" class="btn btn-secondary btn-sm">Clear Form</button>
                    </div>
                </div>
            </div>

            <table class="table table-bordered table-hover bg-white">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Department</th>
                        <th>Salary</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="emp-list"></tbody>
            </table>
            
            <button onclick="logout()" class="btn btn-danger mt-3">Logout</button>
        </div>
    </div>

    <script>
        const API_URL = "https://employee-api-zxoagfut3q-as.a.run.app"; 

        // ตัวแปรสำหรับเช็คสถานะ Edit
        let editMode = false;
        let editId = null;

        // --- Firebase Config (ใส่ค่า Config ของคุณเองตรงนี้ ถ้ายังไม่มี) ---
        // (ปกติ Firebase Hosting จะจัดการให้อัตโนมัติ แต่ใส่ไว้กันเหนียวได้)
        const firebaseConfig = {
            // ... copy จาก Firebase Console มาใส่ถ้าจำเป็น ...
        };
        // firebase.initializeApp(firebaseConfig); // เปิดบรรทัดนี้ถ้าใช้ config manual

        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(result => {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('app-section').style.display = 'block';
                    loadEmp(); // โหลดข้อมูลเมื่อ Login ผ่าน
                })
                .catch(error => alert(error.message));
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                location.reload();
            });
        }

        // --- ฟังก์ชันโหลดข้อมูล (READ) ---
        async function loadEmp() {
            const res = await fetch(`${API_URL}/employees/`);
            const data = await res.json();
            const list = document.getElementById('emp-list');
            list.innerHTML = '';

            data.forEach(e => {
                list.innerHTML += `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.position}</td>
                        <td>${e.department}</td>
                        <td>${e.salary}</td>
                        <td>
                            <button onclick="editEmp('${e.id}', '${e.name}', '${e.position}', '${e.department}', ${e.salary})" 
                                class="btn btn-warning btn-sm">Edit</button>
                            
                            <button onclick="deleteEmp('${e.id}')" 
                                class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- ฟังก์ชันเตรียมแก้ไข (ยัดข้อมูลลงฟอร์ม) ---
        function editEmp(id, name, pos, dept, salary) {
            document.getElementById('name').value = name;
            document.getElementById('pos').value = pos;
            document.getElementById('dept').value = dept;
            document.getElementById('salary').value = salary;

            // เปลี่ยนปุ่มเป็นโหมดแก้ไข
            const btn = document.getElementById('save-btn');
            btn.innerText = "Update";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');

            editMode = true;
            editId = id;
        }

        // --- ฟังก์ชันบันทึก (รองรับทั้ง Create และ Update) ---
        async function saveEmp() {
            const name = document.getElementById('name').value;
            const position = document.getElementById('pos').value;
            const department = document.getElementById('dept').value;
            const salary = parseInt(document.getElementById('salary').value);

            if (!name || !salary) {
                alert("กรุณากรอกชื่อและเงินเดือน");
                return;
            }

            const empData = { name, position, department, salary };
            
            // เช็คว่าจะ POST (ใหม่) หรือ PUT (แก้ไข)
            const method = editMode ? 'PUT' : 'POST';
            const url = editMode ? `${API_URL}/employees/${editId}` : `${API_URL}/employees/`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(empData)
                });

                if (res.ok) {
                    alert(editMode ? "แก้ไขเรียบร้อย!" : "บันทึกสำเร็จ!");
                    resetForm(); // ล้างค่า
                    loadEmp();   // โหลดตารางใหม่
                } else {
                    alert("เกิดข้อผิดพลาดในการบันทึก");
                }
            } catch (err) {
                console.error(err);
                alert("Error connecting to API");
            }
        }

        // --- ฟังก์ชันลบข้อมูล (DELETE) ---
        async function deleteEmp(id) {
            if (confirm('ยืนยันที่จะลบข้อมูลนี้?')) {
                await fetch(`${API_URL}/employees/${id}`, { method: 'DELETE' });
                loadEmp();
            }
        }

        // --- ฟังก์ชันล้างฟอร์ม ---
        function resetForm() {
            document.getElementById('name').value = '';
            document.getElementById('pos').value = '';
            document.getElementById('dept').value = '';
            document.getElementById('salary').value = '';

            // คืนค่าปุ่มกลับเป็นโหมดปกติ
            const btn = document.getElementById('save-btn');
            btn.innerText = "Save";
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');

            editMode = false;
            editId = null;
        }
    </script>
</body>
</html>
